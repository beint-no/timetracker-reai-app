<!DOCTYPE html>
<html lang="en" class="wa-theme-default" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/head :: common-head}"></th:block>
    <title th:text="#{app.title}"></title>
    <script src="https://unpkg.com/htmx.org@2.0.7"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--wa-color-surface-lowered);
            margin: 0;
        }

        .header {
            background: var(--wa-color-surface-default);
            border-bottom: var(--wa-border-width-s) solid var(--wa-color-surface-border);
            padding: var(--wa-space-m) var(--wa-space-xl);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: var(--wa-font-size-xl);
            font-weight: var(--wa-font-weight-bold);
            color: var(--wa-color-brand-fill-loud);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--wa-space-xl);
        }

        .header-sync {
            --wa-button-background: var(--wa-color-purple-60);
            --wa-button-border-color: var(--wa-color-purple-70);
            --wa-button-color: var(--wa-color-purple-05);
        }

        .header-sync:hover,
        .header-sync:focus-visible {
            --wa-button-background: var(--wa-color-purple-50);
            --wa-button-border-color: var(--wa-color-purple-60);
        }

        .entries-scroll {
            overflow-x: auto;
        }

        .timer-input-area {
            padding: var(--wa-space-l);
            border: var(--wa-border-width-s) solid var(--wa-color-brand-border-normal);
            border-radius: var(--wa-border-radius-l);
            background: var(--wa-color-surface-default);
            box-shadow: 0 4px 12px rgba(3, 169, 244, 0.12);
        }

        .timer-input-area.active {
            border-color: var(--wa-color-success-border-normal);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.08), var(--wa-color-surface-default));
        }

        .timer-display {
            font-size: var(--wa-font-size-2xl);
            font-weight: var(--wa-font-weight-bold);
            font-family: 'Courier New', monospace;
            color: var(--wa-color-text-normal);
            min-width: 120px;
            text-align: center;
        }

        .timer-display.running {
            color: var(--wa-color-success-fill-loud);
        }

        .project-name {
            font-weight: var(--wa-font-weight-semibold);
            font-size: var(--wa-font-size-l);
            color: var(--wa-color-neutral-10);
        }

        .duration {
            font-weight: var(--wa-font-weight-bold);
            font-family: 'Courier New', monospace;
            font-size: var(--wa-font-size-l);
            color: var(--wa-color-purple-40);
            background: var(--wa-color-purple-95);
            padding: var(--wa-space-xs) var(--wa-space-s);
            border-radius: var(--wa-border-radius-s);
            border: var(--wa-border-width-s) solid var(--wa-color-purple-80);
        }


        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body th:attr="data-reai-url=${reaiLoginUrl}">
<div id="notification-area"></div>
<header class="header">
        <div class="header-content">
            <div class="wa-split wa-align-items-center">
                <div class="wa-cluster wa-gap-xs logo">
                    <wa-icon name="clock"></wa-icon>
                    <span th:text="#{app.title}"></span>
                </div>
                <div class="wa-cluster wa-gap-m wa-align-items-center" style="flex-wrap: wrap;">
                    <div class="wa-cluster wa-gap-xs wa-align-items-center" style="min-width: 250px;">
                        <span class="wa-text-s" style="color: var(--wa-color-neutral-40);" th:text="#{header.select.employee}"></span>
                        <wa-select id="employee-select"
                                  size="small"
                                  th:attr="placeholder=#{header.select.employee},aria-label=#{header.select.employee}"
                                  hx-get="/htmx/employees"
                                  hx-trigger="load"
                                  hx-swap="innerHTML"
                                  hx-target="this">
                        </wa-select>
                    </div>
                    <wa-button variant="primary" size="small" class="header-sync"
                              hx-post="/htmx/sync"
                              hx-trigger="click"
                              hx-target="#notification-area"
                              hx-swap="innerHTML"
                              hx-vals='js:{employeeId: getSelectedEmployee()}'>
                        <wa-icon name="sync" slot="prefix"></wa-icon>
                        <span th:text="#{header.btn.sync}"></span>
                    </wa-button>
                </div>
            </div>
        </div>
    </header>
<main class="main-content">
        <div class="wa-stack wa-gap-xl">
<div class="wa-grid wa-gap-m" style="--min-column-size: 300px;">
<wa-card>
                    <div class="wa-stack wa-gap-m">
                        <div class="wa-stack wa-gap-s">
                            <h3 style="margin: 0; font-size: var(--wa-font-size-l); font-weight: var(--wa-font-weight-semibold);">
                                <wa-icon name="folder" style="vertical-align: middle;"></wa-icon>
                                <span th:text="#{timer.select.project}"></span>
                            </h3>
                            <wa-select id="timer-project-select"
                                      size="medium"
                                      th:placeholder="#{timer.select.project}"
                                      hx-get="/htmx/projects"
                                      hx-trigger="load"
                                      hx-swap="innerHTML"
                                      hx-target="this"
                                      onchange="handleProjectChange(event)">
                            </wa-select>
                        </div>
<div id="stats-dashboard" style="display: none;">
                            <wa-divider></wa-divider>
                            <div id="stats-content"></div>
                        </div>
                    </div>
                </wa-card>
<wa-card>
                    <div class="timer-input-area" id="timer-input-area">
                        <div class="wa-stack wa-gap-m wa-align-items-center" style="text-align: center;">
                            <div class="timer-display" id="timer-time">00:00:00</div>

                            <div class="wa-cluster wa-gap-m" style="justify-content: center;">
                                <wa-button id="start-btn" variant="success" size="large"
                                          hx-post="/htmx/timer/start"
                                          hx-trigger="click"
                                          hx-target="#timer-display"
                                          hx-vals='js:{employeeId: getSelectedEmployee(), projectId: getSelectedProject(), projectName: getSelectedProjectName()}'>
                                    <wa-icon name="play" slot="prefix"></wa-icon>
                                    <span th:text="#{timer.btn.start}"></span>
                                </wa-button>

                                <wa-button id="stop-btn" variant="danger" size="large" style="display: none;"
                                          hx-post="/htmx/timer/stop"
                                          hx-trigger="click"
                                          hx-target="#timer-display"
                                          hx-vals='js:{employeeId: getSelectedEmployee()}'>
                                    <wa-icon name="stop" slot="prefix"></wa-icon>
                                    <span th:text="#{timer.btn.stop}"></span>
                                </wa-button>
                            </div>
                        </div>
                    </div>

                    <div id="timer-display" style="margin-top: var(--wa-space-m);"></div>
                </wa-card>
            </div>

            <!-- Hidden HTMX triggers -->
            <div style="display: none;">
                <div id="load-timer-trigger"
                     hx-get="/htmx/timer/current"
                     hx-trigger="loadTimer"
                     hx-target="#timer-display"
                     hx-swap="innerHTML"
                     hx-vals='js:{employeeId: getSelectedEmployee()}'></div>

                <div id="load-entries-today-trigger"
                     hx-get="/htmx/entries/today"
                     hx-trigger="loadEntriesToday"
                     hx-target="#entries-content-today"
                     hx-swap="innerHTML"
                     hx-vals='js:{employeeId: getSelectedEmployee(), projectId: getSelectedProject(), limit: 10, offset: 0}'></div>

                <div id="load-entries-all-trigger"
                     hx-get="/htmx/entries/all"
                     hx-trigger="loadEntriesAll"
                     hx-target="#entries-content-all"
                     hx-swap="innerHTML"
                     hx-vals='js:{employeeId: getSelectedEmployee(), projectId: getSelectedProject(), limit: 10, offset: 0}'></div>

                <div id="load-stats-trigger"
                     hx-get="/htmx/stats"
                     hx-trigger="loadStats"
                     hx-target="#stats-content"
                     hx-swap="innerHTML"
                     hx-vals='js:{employeeId: getSelectedEmployee(), projectId: getSelectedProject(), tab: activeTab}'></div>
            </div>

<wa-tab-group id="entries-tab-group">
                <wa-tab slot="nav" panel="today" th:text="#{tab.today}"></wa-tab>
                <wa-tab slot="nav" panel="all" th:text="#{tab.all}"></wa-tab>

                <wa-tab-panel name="today">
                    <div id="entries-content-today">
                        <div class="wa-stack wa-gap-m" style="text-align: center; padding: var(--wa-space-3xl);">
                            <wa-icon name="inbox" style="font-size: 4rem; opacity: 0.3;"></wa-icon>
                            <h3 th:text="#{empty.no.entries}"></h3>
                            <p style="color: var(--wa-color-neutral-40);" th:text="#{empty.select.employee}"></p>
                        </div>
                    </div>
                </wa-tab-panel>

                <wa-tab-panel name="all">
                    <div id="entries-content-all">
                        <div class="wa-stack wa-gap-m" style="text-align: center; padding: var(--wa-space-3xl);">
                            <wa-icon name="inbox" style="font-size: 4rem; opacity: 0.3;"></wa-icon>
                            <h3 th:text="#{empty.no.entries.all}"></h3>
                            <p style="color: var(--wa-color-neutral-40);" th:text="#{empty.start.tracking.all.entries}"></p>
                        </div>
                    </div>
                </wa-tab-panel>
            </wa-tab-group>
        </div>
    </main>

    <script>
        let timerInterval = null;
        let timerStartTime = null;
        let activeTab = 'today';

        function getAuthToken() {
            const urlParams = new URLSearchParams(window.location.search);

            const code = urlParams.get('code');
            if (code) {
                exchangeCodeForTokens(code);
                return '';
            }

            const clientId = urlParams.get('client_id');
            const clientSecret = urlParams.get('client_secret');
            const scope = urlParams.get('scope');

            if (clientId && clientSecret) {
                localStorage.setItem('reai_client_id', clientId);
                localStorage.setItem('reai_client_secret', clientSecret);
                if (scope) {
                    localStorage.setItem('reai_scope', scope);
                }

                window.history.replaceState({}, document.title, window.location.pathname);
                setTimeout(() => startOAuth2Flow(), 100);
                return '';
            }

            const urlToken = urlParams.get('access_token');
            const urlRefreshToken = urlParams.get('refresh_token');
            if (urlToken) {
                localStorage.setItem('reai_access_token', 'Bearer ' + urlToken);
                if (urlRefreshToken) {
                    localStorage.setItem('reai_refresh_token', urlRefreshToken);
                }
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            return localStorage.getItem('reai_access_token') || '';
        }

        async function exchangeCodeForTokens(code) {
            try {
                const clientId = localStorage.getItem('reai_client_id');
                const clientSecret = localStorage.getItem('reai_client_secret');

                console.log('Exchanging code for tokens...');

                if (!clientId || !clientSecret) {
                    throw new Error('Client credentials not found');
                }

                const response = await fetch('/api/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        clientId: clientId,
                        clientSecret: clientSecret
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to exchange authorization code');
                }

                const data = await response.json();

                localStorage.setItem('reai_access_token', 'Bearer ' + data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('reai_refresh_token', data.refresh_token);
                }

                console.log('Tokens saved successfully');
                window.history.replaceState({}, document.title, window.location.pathname);
                window.location.reload();
            } catch (error) {
                console.error('Error exchanging code:', error);
                showTokenDialog();
            }
        }

        function getRefreshToken() {
            return localStorage.getItem('reai_refresh_token') || '';
        }

        function getClientId() {
            return localStorage.getItem('reai_client_id') || '';
        }

        function getClientSecret() {
            return localStorage.getItem('reai_client_secret') || '';
        }

        function getScope() {
            return localStorage.getItem('reai_scope') || 'contact:read';
        }

        function startOAuth2Flow() {
            const clientId = getClientId();
            let scope = getScope();

            if (!clientId) {
                console.error('No client_id found');
                showTokenDialog();
                return;
            }

            scope = scope.replace(/,/g, ' ');

            const reaiBaseUrl = document.body.dataset.reaiUrl || 'http://localhost:8080';
            const authUrl = new URL('/oauth2/authorize', reaiBaseUrl);
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('client_id', clientId);
            authUrl.searchParams.set('redirect_uri', window.location.origin);
            authUrl.searchParams.set('scope', scope);

            console.log('Starting OAuth2 flow, redirecting to:', authUrl.toString());

            window.location.href = authUrl.toString();
        }

        async function refreshAccessToken() {
            const refreshToken = getRefreshToken();
            const clientId = getClientId();
            const clientSecret = getClientSecret();

            if (!refreshToken || !clientId || !clientSecret) {
                console.error('Missing credentials for token refresh');
                startOAuth2Flow();
                return false;
            }

            try {
                const response = await fetch('/api/oauth2/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refreshToken: refreshToken,
                        clientId: clientId,
                        clientSecret: clientSecret
                    })
                });

                if (!response.ok) {
                    console.error('Failed to refresh token, status:', response.status);
                    if (response.status === 400 || response.status === 401) {
                        console.log('Refresh token invalid or expired, restarting OAuth flow...');
                        startOAuth2Flow();
                        return false;
                    }
                    throw new Error('Failed to refresh token');
                }

                const data = await response.json();

                localStorage.setItem('reai_access_token', 'Bearer ' + data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('reai_refresh_token', data.refresh_token);
                }

                console.log('Access token refreshed successfully');
                return true;
            } catch (error) {
                console.error('Error refreshing token:', error);
                startOAuth2Flow();
                return false;
            }
        }

        function isTokenExpired(token) {
            if (!token || !token.startsWith('Bearer ')) return true;
            try {
                const jwtToken = token.replace('Bearer ', '');
                const payload = JSON.parse(atob(jwtToken.split('.')[1]));
                return Date.now() >= payload.exp * 1000;
            } catch (error) {
                return true;
            }
        }

        function checkToken() {
            const token = getAuthToken();
            if (!token || isTokenExpired(token)) {
                showTokenDialog();
                return false;
            }
            return true;
        }

        function showTokenDialog() {
            document.getElementById('token-dialog').open = true;
        }

        function closeTokenDialog() {
            document.getElementById('token-dialog').open = false;
        }

        function goToReai() {
            window.location.href = document.body.dataset.reaiUrl || 'http://localhost:8080';
        }

        function getSelectedEmployee() {
            const value = document.getElementById('employee-select')?.value;
            return value && value !== '' ? Number(value) : null;
        }

        function getSelectedProject() {
            const value = document.getElementById('timer-project-select')?.value;
            if (value === 'all' || !value) return null;
            return Number(value);
        }

        function getSelectedProjectName() {
            const select = document.getElementById('timer-project-select');
            if (!select || !select.value) return '';
            const option = select.querySelector(`wa-option[value="${select.value}"]`);
            return option ? option.textContent : '';
        }

        function handleProjectChange() {
            if (getSelectedEmployee()) {
                loadEntriesForTab(activeTab);
                updateStatsDashboard();
            }
        }

        // Trigger HTMX requests via custom events
        function loadEntriesForTab(tabName) {
            if (!getSelectedEmployee()) return;

            const triggerId = tabName === 'all' ? 'load-entries-all-trigger' : 'load-entries-today-trigger';
            htmx.trigger(`#${triggerId}`, tabName === 'all' ? 'loadEntriesAll' : 'loadEntriesToday');
        }

        function updateStatsDashboard() {
            const employeeId = getSelectedEmployee();
            if (!employeeId) {
                document.getElementById('stats-dashboard').style.display = 'none';
                return;
            }

            htmx.trigger('#load-stats-trigger', 'loadStats');
            setTimeout(() => {
                if (getSelectedEmployee()) {
                    document.getElementById('stats-dashboard').style.display = 'block';
                }
            }, 100);
        }

        // Timer display functions
        function startTimerDisplay(startTime) {
            timerStartTime = new Date(startTime);
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - timerStartTime;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                const display = document.getElementById('timer-time');
                if (display) {
                    display.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    display.classList.add('running');
                }
            }, 1000);

            document.getElementById('timer-input-area').classList.add('active');
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-flex';
        }

        function stopTimerDisplay() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            const display = document.getElementById('timer-time');
            if (display) {
                display.textContent = '00:00:00';
                display.classList.remove('running');
            }
            document.getElementById('timer-input-area').classList.remove('active');
            document.getElementById('start-btn').style.display = 'inline-flex';
            document.getElementById('stop-btn').style.display = 'none';
        }

        document.body.addEventListener('htmx:afterSwap', (event) => {
            if (event.detail?.target?.id === 'employee-select') {
                const employeeId = getSelectedEmployee();
                if (employeeId) {
                    loadEntriesForTab(activeTab);
                    updateStatsDashboard();
                    htmx.trigger('#load-timer-trigger', 'loadTimer');
                }
            }

            if (event.detail?.target?.id === 'timer-project-select') {
                const employeeId = getSelectedEmployee();
                if (employeeId) {
                    loadEntriesForTab(activeTab);
                    updateStatsDashboard();
                }
            }
        });

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            checkToken();

            // Tab changes
            document.getElementById('entries-tab-group').addEventListener('wa-tab-show', (event) => {
                activeTab = event.detail.name;
                loadEntriesForTab(activeTab);
            });

            // Load initial data if employee is selected
            setTimeout(() => {
                const employeeId = getSelectedEmployee();
                if (employeeId) {
                    htmx.trigger('#load-timer-trigger', 'loadTimer');
                    loadEntriesForTab('all');
                    updateStatsDashboard();
                }
            }, 500);
        });

        // HTMX events
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            // Timer display updates
            if (evt.detail.target.id === 'timer-display') {
                const timerDiv = evt.detail.target.querySelector('[data-running]');
                if (timerDiv) {
                    const running = timerDiv.getAttribute('data-running');
                    const startTime = timerDiv.getAttribute('data-start-time');
                    if (running === 'true' && startTime) {
                        startTimerDisplay(startTime);
                    } else {
                        stopTimerDisplay();
                    }
                } else {
                    stopTimerDisplay();
                }
            }

            // Update stats when entries load
            if (evt.detail.target.id.startsWith('entries-content')) {
                updateStatsDashboard();
            }
        });

        // Add auth header to all HTMX requests
        document.body.addEventListener('htmx:configRequest', async function(evt) {
            let token = getAuthToken();

            console.log('Token check:', token ? 'exists' : 'missing');
            if (token) {
                const isExpired = isTokenExpired(token);
                console.log('Token expired:', isExpired);
                if (isExpired) {
                    try {
                        const payload = JSON.parse(atob(token.replace('Bearer ', '').split('.')[1]));
                        console.log('Token exp:', new Date(payload.exp * 1000).toISOString());
                        console.log('Current time:', new Date().toISOString());
                    } catch(e) {}
                }
            }

            if (token && isTokenExpired(token)) {
                console.log('Access token expired, attempting refresh...');
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    token = getAuthToken();
                } else {
                    evt.preventDefault();
                    showTokenDialog();
                    return;
                }
            }

            if (!token) {
                evt.preventDefault();
                showTokenDialog();
                return;
            }

            evt.detail.headers['Authorization'] = token;
        });

        // Handle auth errors
        document.body.addEventListener('htmx:responseError', function(evt) {
            if (evt.detail.xhr.status === 401) {
                showTokenDialog();
            }
        });

        // Reload entries after timer actions
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'timer-display') {
                // Reload entries when timer starts or stops
                const employeeId = getSelectedEmployee();
                if (employeeId) {
                    loadEntriesForTab(activeTab);
                }
            }

            // Reload entries after sync
            if (evt.detail.target.id === 'notification-area') {
                const employeeId = getSelectedEmployee();
                if (employeeId) {
                    loadEntriesForTab(activeTab);
                }
            }
        });
    </script>
</body>
</html>
